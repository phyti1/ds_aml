---
title: "aml"
subtitle: "Mini-Challenge 1"
author: "Pascal Berger und Raphael Strebel"
date: "18. Oktober 2022"
output:
  html_notebook:
    toc: true
    toc_depth: 4
    df_print: paged
    toc_float:
      collapsed: true
      smooth_scroll: true
    theme: united
    highlight: tango
    code_folding: hide
---
R-Version: **[Default] [64-bit] C:\\Program Files\\R\\R-4.1.0**


```{r echo=FALSE, cache=FALSE, results=FALSE, comment=FALSE, warning=FALSE}
# clear environment
rm(list = ls())

# nötige Packete
packages <- c("tidyverse", "data.table", "tidymodels", "lubridate")

# Noch nicht installierte Pakete installieren
installed_packages <- packages %in% rownames(installed.packages())

if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Laden der Packete
invisible(lapply(packages, library, character.only = TRUE))

# change options
options(dplyr.summarise.inform = FALSE)
```

In folgendem Junk werden alle Tabellen aus den CSV's eingelesen.
Doku Daten: https://sorry.vse.cz/~berka/challenge/PAST/index.html
(rechte Seite PKDD'99 Challenge > Data > Financial Data Description)


```{r}
root_path <- "./xselling_banking_data-1/xselling_banking_data/"

account <- read.csv(paste0(root_path, "account.csv"), header = TRUE, sep = ";")
card <- read.csv(paste0(root_path, "card.csv"), header = TRUE, sep = ";")
client <- read.csv(paste0(root_path, "client.csv"), header = TRUE, sep = ";")
disp <- read.csv(paste0(root_path, "disp.csv"), header = TRUE, sep = ";")
district <- read.csv(paste0(root_path, "district.csv"), sep = ";")
loan <- read.csv(paste0(root_path, "loan.csv"), header = TRUE, sep = ";")
order <- read.csv(paste0(root_path, "order.csv"), header = TRUE, sep = ";")
trans <- read.csv(paste0(root_path, "trans.csv"), header = TRUE, sep = ";")
```

```{r}
account
```
Bei account muss das Datum noch umgewandlet werden.

```{r}
account$date <- as.Date(as.character(account$date), format= "%y%m%d")
```


```{r}
card
```
Auch bei card muss das Datum umgewandelt werden, der zeitliche Teil wird ignoriert, da er immer 0 ist.

```{r}
card$issued <- as.Date(as.character(card$issued), format= "%y%m%d")
```


```{r}
client
```

In der Tabelle existiert die Spalte birth_number, welcher man auf den ersten Blick die Datumsräpresentation nicht ansieht.
In der Doku wird die Struktur deutlich, sie ist für Männer YYMMDD und für Frauen YYMMDD+50DD.
In Folge wird die Nummer in ihre Datumsräpresentation konvertiert und die Spalte "gender" als male/female aufgeschlüsselt.
Zudem wird das Alter der clients bezogen auf das Jahr 1999 herausextrahiert, da der Datensatz aus diesem Jahr stammt.
Es wird nicht year(Sys.Date()) verwendet, damit die Daten auch in Zukunft konsistent blieben.



```{r}
#Neue Spalte mit dem Geschlecht einfügen
client <- client %>% mutate(gender = ifelse(substr(birth_number, 3, 4) > 12, "female", "male"))

#Die Spalte birth_number abändern. Temporäre Spalte birth_month generieren.
client <- client %>% mutate(birth_month = ifelse(as.numeric(substr(birth_number, 3, 4)) > 12,
                            as.numeric(substr(birth_number, 3, 4)) - 50,
                            as.numeric(substr(birth_number, 3, 4))))

client <- client %>% mutate(birth_number = paste("19", substr(birth_number, 1, 2), str_pad(birth_month, 2, pad = "0"), substr(birth_number, 5, 6), sep = "", collapse = NULL))

#Format der Spalte birth_number ändern
client$birth_number <- as.Date(as.character(client$birth_number), format= "%Y%m%d")
#Spalte birth_month löschen
client$birth_month <- NULL


#Neue Spalte für das Alter in der Tabelle 
client <- client %>% mutate(age = 1999 - year(birth_number))
```


```{r}
disp
```

Bei Dispositions sollen nur Owners verwendet werden, da die Analyse nur Eigentümer von Konten behandeln soll.

```{r}
disp <- disp %>% filter(type == 'OWNER')
```

Bei district sind die Spaltennamen der Tabelle abhanden gekommen.
Hier werden die Tabellennamen umbenannt, gemäss Doku.

```{r}
#Umbennenung der Werte in der Spalte district_id
district <- rename(district, district_id = A1, district_name = A2, region = A3, 
                   inhabitants = A4, municipalities_inhabitants_up_to_499 = A5, 
                   municipalities_inhabitants_500_to_1999 = A6, 
                   municipalities_inhabitants_2000_to_9999 = A7, 
                   municipalities_inhabitants_up_to_10000 = A8, cities = A9, 
                   urban_inhabitants_ratio = A10, average_salary = A11,
                   unemployment_rate_95 = A12, unemployment_rate_96 = A13,
                   entrepreneurs_per_1000 = A14, crimes_95 = A15,
                   crimes_96 = A16)
```


In den Transaktionen muss das Datum gemäss Format YYMMDD konvertiert werden.

```{r}
trans$date <- as.Date(as.character(trans$date), format= "%y%m%d")
```


In diesem Abschnitt werden die verschiedenen Tabellen zusammen gesetzt.
Dabei werden loan, cards und district it left join angehängt, damit fehlende Spalten nicht den Datensatz verkleinern.
Die Transaktionsdaten werden hier noch nicht zusammengeführt.

```{r}
# Clients mit dispositions
full <- inner_join(client, disp, by = "client_id", suffix = c(".client", ".dispositions"))
sum(duplicated(full$client_id))

# Full mit account
full <- inner_join(full, account, by = "account_id", suffix = c("", ".accounts"))
sum(duplicated(full$account_id))

# Full mit loan
sum(duplicated(loan$account_id))
full <- left_join(full, loan, by = "account_id", suffix = c("", ".loans"))

# Full mit cards
full <- left_join(full, card, by = "disp_id", suffix = c("", ".cards"))
sum(duplicated(card$disp_id))

# District Informations for client
full <- left_join(full, district, by = "district_id")

# District informations for card
full <- left_join(full, district, by = c("district_id.accounts"="district_id"), suffix = c("", ".accounts"))

sample_n(full, 5)
```

Jugendliche und Personen, welche während des Zeitraums des Datensatzes erst erwachsen worden sind, sollen nicht in die Auswertung einfliessen.
Da sicher der Datensatz über einen Zeitraum von sechs Jahren erstrekt werden alle Clients jünger als 25 Jahre herausgefiltert.

```{r}
min(trans$date)
max(trans$date)

full <- full %>% filter(age >= 25)
```



```{r}
full
```

Als nächstes werden alle Zeilen mit Kreditkartenkäufen herausgeschrieben.


```{r}
card_buyers <- full %>% filter(!is.na(issued))
sum(duplicated(card_buyers$client_id))
```
Es liegen keine Kunden vor, welche mehr als einmal eine Kreditkarte gekauft haben.


Zu jedem Kartenkäufer soll ein ähnlicher Nicht Käufer gefunden werden.
sie sollen sich in Alter und Geschlecht ähnlich sein.


```{r}
non_buyers <- full %>% filter(is.na(issued))

# copy and clear df reduced
non_buyers_reduced <- data.frame(non_buyers)
non_buyers_reduced <- non_buyers_reduced[0,]

for (i in 1:nrow(card_buyers))
{
  buyer <- card_buyers[i, ]
  non_buyer <- non_buyers %>% filter(age == buyer$age & gender == buyer$gender)
  found = FALSE
  if(nrow(non_buyer) < 1)
  {
    # handle if required
  }
  else
  {
    
    # assure new values are added to the new df
    # exclusive left join
    new <- setdiff(non_buyer, non_buyers_reduced)
    if(nrow(new) > 0)
    {
      non_buyers_reduced <- rbind(non_buyers_reduced, new[1,])
      found = TRUE
    }
  }
  if(!found)
  {
    print("no matching non-buyer found!")
  }
}

sum(duplicated(non_buyers_reduced))
non_buyers_reduced

```


in folgendem Abschnitt werden die buyers und korrespondierenden non-buyers auf auf issued - 13 bis issued - 1 Monate gefiltert und anschliessend gruppiert.

```{r}

window <- left_join(trans, card_buyers[ , c("client_id", "account_id", "issued")], by='account_id')

# get all transaction withing 12 month prior to credit card issuance
window <- window %>% group_by(client_id) %>% filter(date %m+% months(13) > issued & date %m+% months(1) < issued) %>% ungroup()

window <- group_by(month = lubridate::floor_date(window$issued, 'month')) %>% summarize(sum = sum(value_column))

```



```{r}
window
```


---
Spielwiese



In diesem Abschnitt werden alle Transaktionen bis 12 Monate vor dem Kreditkartenkauf herausgefiltert.

```{r}

window <- left_join(trans, client_analytical_record[ , c("client_id", "account_id", "issued")], by='account_id')

# get all transaction withing 12 month prior to credit card issuance
window <- window %>% group_by(client_id) %>% filter(date %m+% months(12) > issued & date < issued) %>% ungroup()

# mark all transactions within 1 month prior to card issuance as lag
window <- window %>% mutate(lag = ifelse(date %m+% months(1) > issued, 1, 0))

window 
```





